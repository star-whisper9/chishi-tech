import{r as t,A as x,j as e,C as F,v as V,S as y,w as P,T as C,P as U,D as $,t as O,x as z,z as W,M as X}from"./index-YIbqy0ww.js";import{S as Y,A as Z}from"./Slider-Ctp0neKm.js";import{T as H,C as K,S as q}from"./TextField-EoF9C-q3.js";import"./Select-CN7qvmCw.js";function G(){const[n,o]=t.useState("idle"),[u,a]=t.useState(0),[M,i]=t.useState(null),[h,w]=t.useState(null),[d,D]=t.useState(null),[j,E]=t.useState(x.BADVIDEO.MIN_PERCENT),p=t.useRef(null),I=t.useRef(null),f=n==="processing",g=t.useCallback(s=>{const v=x.BADVIDEO.MIN_PERCENT,B=x.BADVIDEO.MAX_PERCENT;return Math.min(B,Math.max(v,s))},[]),m=t.useCallback(()=>{h&&URL.revokeObjectURL(h),w(null)},[h]),l=t.useCallback(()=>{p.current&&(p.current.terminate(),p.current=null)},[]),c=t.useCallback(()=>{I.current=null},[]),k=t.useCallback(()=>{o("idle"),a(0),i(null),D(null),E(x.BADVIDEO.MIN_PERCENT),m(),c(),l()},[c,m,l]),A=t.useCallback(s=>{D(s),i(null),a(0),m()},[m]),S=t.useCallback(async()=>{if(!d){i("请先选择 MP4 文件。");return}if(f)return;if(d.size>x.BADVIDEO.MAX_FILE_SIZE_BYTES){i(`文件过大，最大允许 ${(x.BADVIDEO.MAX_FILE_SIZE_BYTES/(1024*1024)).toFixed(0)} MB。`);return}const s=d.name.toLowerCase();if(!(d.type==="video/mp4"||s.endsWith(".mp4"))){i("仅支持 MP4 文件。");return}o("processing"),a(0),i(null),m();const B=await d.arrayBuffer();I.current=B;const R=new Worker(new URL("/assets/corruptWorker-a8lwKM8m.js",import.meta.url),{type:"module"});p.current=R,R.onmessage=L=>{const b=L.data;if(b?.type==="progress")a(Math.max(0,Math.min(1,Number(b.value)||0)));else if(b?.type==="done"){const _=new Blob([b.buffer],{type:"video/mp4"}),T=URL.createObjectURL(_);w(T),o("done"),a(1),c(),l()}else b?.type==="error"?(i(b.message||"处理失败"),o("error"),c(),l()):b?.type==="cancelled"&&(o("cancelled"),c(),l())},R.onerror=L=>{i(L.message??"Worker 错误"),o("error"),c(),l()},R.postMessage({type:"start",buffer:B,percent:g(j)},[B])},[f,g,m,d,j,l,c]),r=t.useCallback(()=>{if(p.current){try{p.current.postMessage({type:"cancel"})}catch{}l(),o("cancelled"),a(0),c()}},[l,c]);return t.useEffect(()=>{const s=()=>{l(),c()};return window.addEventListener("beforeunload",s),()=>{window.removeEventListener("beforeunload",s)}},[l,c]),t.useMemo(()=>({status:n,progress:u,error:M,outputUrl:h,file:d,percent:j,setPercent:s=>E(g(s)),selectFile:A,start:S,cancel:r,reset:k}),[n,u,M,h,d,j,g,A,S,r,k])}const N=n=>`${(n/(1024*1024)).toFixed(0)} MB`,J=()=>{const{status:n,error:o,outputUrl:u,file:a,percent:M,setPercent:i,selectFile:h,start:w,cancel:d,reset:D}=G(),j=n==="processing",E=x.BADVIDEO.MIN_PERCENT*100,p=x.BADVIDEO.MAX_PERCENT*100,[I,f]=t.useState(!1),[g,m]=t.useState("处理完成"),[l,c]=t.useState("success"),k=t.useMemo(()=>(M*100).toFixed(3),[M]),[A,S]=t.useState(null);return t.useEffect(()=>{let r=null;return a?(r=URL.createObjectURL(a),S(r)):S(null),()=>{r&&URL.revokeObjectURL(r)}},[a]),t.useEffect(()=>{n==="done"?(m("处理完成，可下载结果文件"),c("success"),f(!0)):n==="error"?(m(o||"处理失败"),c("error"),f(!0)):n==="cancelled"&&(m("已取消处理"),c("info"),f(!0))},[n,o]),e.jsxs(F,{elevation:3,children:[e.jsx(V,{children:e.jsxs(y,{spacing:2,children:[e.jsxs(y,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{sm:"center"},children:[e.jsxs(P,{component:"label",variant:"contained",disabled:j,children:["选择 MP4 文件",e.jsx("input",{type:"file",hidden:!0,accept:"video/mp4,.mp4",onChange:r=>{const s=r.target.files?.[0]??null;h(s)}})]}),e.jsx(C,{variant:"body2",color:"text.secondary",children:a?`${a.name} — ${N(a.size)}`:`最大大小 ${N(x.BADVIDEO.MAX_FILE_SIZE_BYTES)}，仅支持 .mp4`})]}),e.jsx(U,{variant:"outlined",sx:{p:2},children:e.jsxs(y,{spacing:2,children:[e.jsx(C,{variant:"subtitle2",color:"text.secondary",children:"损坏百分比（%）"}),e.jsx(Y,{value:Number(k),min:E,max:p,step:.005,valueLabelDisplay:"auto",valueLabelFormat:r=>`${r.toFixed(3)}%`,onChange:(r,s)=>{const v=Array.isArray(s)?s[0]:s;i(Number(v)/100)}}),e.jsx(y,{direction:"row",spacing:2,alignItems:"center",children:e.jsx(H,{label:"百分比",type:"number",size:"small",sx:{width:200},slotProps:{htmlInput:{step:.005,min:E,max:p}},value:k,onChange:r=>{const s=Number(r.target.value);if(!Number.isFinite(s))return;const v=Math.min(p,Math.max(E,s));i(v/100)}})})]})}),a&&e.jsxs(U,{variant:"outlined",sx:{p:2},children:[e.jsx(C,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"原视频预览"}),e.jsx($,{sx:{mb:2}}),e.jsx(O,{sx:{maxWidth:"100%"},children:e.jsx("video",{controls:!0,src:A??void 0,style:{width:"100%",borderRadius:8}})})]}),e.jsxs(y,{direction:"row",spacing:2,children:[e.jsx(P,{variant:"contained",onClick:w,disabled:!a||j,children:"开始处理"}),e.jsx(P,{variant:"outlined",color:"warning",onClick:d,disabled:n!=="processing",children:"取消"}),e.jsx(P,{variant:"contained",color:"success",disabled:!u||n!=="done",onClick:()=>{if(!u)return;const r=document.createElement("a");r.href=u;const s=a?.name??"output.mp4";r.download=s.replace(/\.mp4$/i,".bad.mp4"),document.body.appendChild(r),r.click(),r.remove()},children:"下载结果"}),e.jsx(P,{variant:"text",color:"inherit",onClick:D,children:"重置"})]}),n==="processing"&&e.jsx(O,{sx:{display:"flex",justifyContent:"center"},children:e.jsx(z,{size:40})}),o&&e.jsx(C,{color:"error",children:o})]})}),e.jsx(K,{}),e.jsx(q,{open:I,autoHideDuration:4e3,onClose:()=>f(!1),anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(Z,{severity:l,onClose:()=>f(!1),sx:{width:"100%"},children:g})})]})},re=()=>{let n="随机损坏 MP4",o="导出一个每字节有概率损坏的 MP4 视频文件。";for(const u of W)u.link==="/badvideo"&&(n=u.title,o=u.description);return e.jsx(X,{children:e.jsx(O,{sx:{py:6},children:e.jsxs(y,{spacing:4,children:[e.jsxs(O,{textAlign:"center",children:[e.jsx(C,{variant:"h3",gutterBottom:!0,children:n}),e.jsx(C,{variant:"h6",color:"text.secondary",children:o})]}),e.jsx(J,{})]})})})};export{re as default};
