(function(){"use strict";let u=!1;function c(n){self.postMessage(n)}class f{pool=new Uint32Array(0);idx=0;static BYTES_LIMIT=65536;static DEFAULT_UINT32_COUNT=f.BYTES_LIMIT/4;refill(t=f.DEFAULT_UINT32_COUNT){t*4>f.BYTES_LIMIT&&(t=f.DEFAULT_UINT32_COUNT),this.pool=new Uint32Array(t),self.crypto.getRandomValues(this.pool),this.idx=0}nextUint32(){return this.idx>=this.pool.length&&this.refill(),this.pool[this.idx++]}nextByte(){return this.nextUint32()&255}intInRange(t,s){const e=this.nextUint32()>>>0,r=s-t+1>>>0;return t+e%r}}const T=new f;function M(n,t){return n[t]<<24|n[t+1]<<16|n[t+2]<<8|n[t+3]}function E(n){const t=new Uint8Array(n),s=[];let e=0;const r=t.length;for(;e+8<=r;){const g=M(t,e),p=t[e+4],y=t[e+5],i=t[e+6],d=t[e+7],o=p===109&&y===100&&i===97&&d===116;if(g===0){const I=e+8,x=r;o&&I<x&&s.push({start:I,end:x});break}let a=g>>>0,U=!1;a===1&&(a=r-e,U=!0);const h=e+8,l=e+a;if(l>r||a<8||(o&&h<l&&s.push({start:h,end:l}),e=l,!U&&a===0))break}return s}function w(n){const t=T.intInRange(0,7);return n^1<<t}async function L(n,t){u=!1;const s=new Uint8Array(n),e=E(n);if(e.length===0)throw new Error("未找到 mdat 区域，无法进行损坏处理。");let r=0;for(const i of e)r+=i.end-i.start;const g=Math.max(1,Math.floor(r*t));let p=0,y=0;for(const i of e){if(u){c({type:"cancelled"});return}const d=i.end-i.start;let o=Math.floor(d*t);const a=g-p;if(e.length-y===1&&(o=a),o>d&&(o=d),o<=0){y++;continue}for(let h=0;h<o;h++){if(u){c({type:"cancelled"});return}const l=i.start+T.intInRange(0,d-1);s[l]=w(s[l]),p++,(p&16383)===0&&(c({type:"progress",value:p/g}),await Promise.resolve())}y++}c({type:"progress",value:1}),c({type:"done",buffer:n})}self.onmessage=n=>{const t=n.data;if(t.type==="cancel"){u=!0;return}t.type==="start"&&L(t.buffer,t.percent).catch(s=>{const e=s instanceof Error?s.message:String(s);c({type:"error",message:e})})}})();
