openapi: 3.1.0
info:
  title: GitHub Contributions API
  version: v4
  description: |
    通过抓取用户 GitHub 个人资料页面，返回 GitHub 贡献数据的 API 服务。
    ⚠️ 注意：结果会缓存 1 小时！
  contact:
    name: GitHub Repository
    url: https://github.com/grubersjoe/github-contributions-api

servers:
  - url: https://github-contributions-api.jogruber.de
    description: 原版官方托管
  - url: https://api.f1a.me/github-contributions-api
    description: 赤石科技镜像托管

tags:
  - name: contributions
    description: GitHub 贡献数据相关接口

paths:
  /:
    get:
      summary: 获取 API 欢迎信息
      description: 返回 API 的基本信息和文档链接
      operationId: getWelcome
      tags:
        - contributions
      responses:
        "200":
          description: 成功返回欢迎信息
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Welcome to the GitHub Contributions API.
                  version:
                    type: string
                    example: v4
                  docs:
                    type: string
                    format: uri
                    example: https://github-contributions-api.jogruber.de

  /v4:
    get:
      summary: 重定向到根路径
      description: 重定向到 API 根路径
      operationId: redirectToRoot
      tags:
        - contributions
      responses:
        "302":
          description: 重定向到根路径

  /v4/{username}:
    get:
      summary: 获取用户的 GitHub 贡献数据
      description: |
        根据 GitHub 用户名获取该用户的贡献历史数据。支持按年份筛选和嵌套格式输出。

        **缓存机制**：
        - 结果默认缓存 1 小时
        - 可通过 `cache-control: no-cache` 请求头强制刷新（请谨慎使用）
        - 响应头包含 `age` 和 `x-cache` 字段提供缓存状态信息
      operationId: getUserContributions
      tags:
        - contributions
      parameters:
        - name: username
          in: path
          required: true
          description: GitHub 用户名
          schema:
            type: string
          example: grubersjoe

        - name: y
          in: query
          required: false
          description: |
            年份筛选参数，可以是：
            - 具体年份数字（如 2020）
            - `all`：所有年份（默认）
            - `last`：最近一年（GitHub 默认视图）
            - 可多次传递以选择多个年份
          schema:
            oneOf:
              - type: string
                enum: [all, last]
              - type: integer
                minimum: 2000
              - type: array
                items:
                  oneOf:
                    - type: string
                      enum: [all, last]
                    - type: integer
                      minimum: 2000
          examples:
            all:
              value: all
              summary: 所有年份
            last:
              value: last
              summary: 最近一年
            specific:
              value: 2020
              summary: 指定年份
            multiple:
              value: [2020, 2021]
              summary: 多个年份

        - name: format
          in: query
          required: false
          description: 响应数据格式，`nested` 表示按年/月/日嵌套的对象结构
          schema:
            type: string
            enum: [nested]
          example: nested

        - name: cache-control
          in: header
          required: false
          description: 缓存控制，使用 `no-cache` 可强制刷新数据
          schema:
            type: string
            enum: [no-cache]

      responses:
        "200":
          description: 成功返回贡献数据
          headers:
            age:
              description: 缓存存在时长（秒）
              schema:
                type: integer
              example: 1800
            x-cache:
              description: 缓存命中状态
              schema:
                type: string
                enum: [HIT, MISS]
              example: HIT
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Response"
                  - $ref: "#/components/schemas/NestedResponse"
              examples:
                standardFormat:
                  summary: 标准格式（数组）
                  value:
                    total:
                      2020: 492
                      2021: 358
                    contributions:
                      - date: "2020-01-01"
                        count: 0
                        level: 0
                      - date: "2020-01-02"
                        count: 9
                        level: 4
                      - date: "2020-01-03"
                        count: 5
                        level: 2
                nestedFormat:
                  summary: 嵌套格式（对象）
                  value:
                    total:
                      2020: 492
                    contributions:
                      2020:
                        1:
                          1:
                            date: "2020-01-01"
                            count: 9
                            level: 4
                          2:
                            date: "2020-01-02"
                            count: 5
                            level: 2

        "400":
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidFormat:
                  summary: format 参数无效
                  value:
                    error: "Query parameter 'format' must be 'nested' or undefined"
                invalidYear:
                  summary: y 参数无效
                  value:
                    error: "Query parameter 'y' must be an integer, 'all' or 'last'"

        "404":
          description: 用户不存在
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: 'User "nonexistentuser" not found.'

        "500":
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Failed scraping contribution data of 'username': unexpected error"

components:
  schemas:
    Contribution:
      type: object
      description: 单日贡献数据
      required:
        - date
        - count
        - level
      properties:
        date:
          type: string
          format: date
          description: 日期（ISO 8601 格式）
          example: "2020-01-01"
        count:
          type: integer
          minimum: 0
          description: 当日贡献次数
          example: 9
        level:
          type: integer
          enum: [0, 1, 2, 3, 4]
          description: |
            贡献强度等级：
            - 0: 无贡献
            - 1: 低强度
            - 2: 中低强度
            - 3: 中高强度
            - 4: 高强度
          example: 4

    Response:
      type: object
      description: 标准格式的贡献数据响应（数组形式）
      required:
        - total
        - contributions
      properties:
        total:
          type: object
          description: 各年份的总贡献次数
          additionalProperties:
            type: integer
          example:
            2020: 492
            2021: 358
            lastYear: 425
        contributions:
          type: array
          description: 按时间顺序排列的贡献数据数组
          items:
            $ref: "#/components/schemas/Contribution"

    NestedResponse:
      type: object
      description: 嵌套格式的贡献数据响应（按年/月/日嵌套的对象结构）
      required:
        - total
        - contributions
      properties:
        total:
          type: object
          description: 各年份的总贡献次数
          additionalProperties:
            type: integer
          example:
            2020: 492
            lastYear: 425
        contributions:
          type: object
          description: 按年/月/日三层嵌套的贡献数据对象
          additionalProperties:
            type: object
            description: 年份（数字键）
            additionalProperties:
              type: object
              description: 月份（数字键，1-12）
              additionalProperties:
                $ref: "#/components/schemas/Contribution"
          example:
            2020:
              1:
                1:
                  date: "2020-01-01"
                  count: 9
                  level: 4
                2:
                  date: "2020-01-02"
                  count: 5
                  level: 2

    ErrorResponse:
      type: object
      description: 错误响应
      required:
        - error
      properties:
        error:
          type: string
          description: 错误信息描述
          example: 'User "username" not found.'
